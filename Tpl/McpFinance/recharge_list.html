{extends file="../acp.html"}

{block name="title"}{$head_title}{/block}
{block name="content"}
<div class="tablesWrap">
    <form   method="post" action="">
        <div class="tables-searchbox">
            <span class="tbs-txt">账户余额 : {$left_money}</span>
        </div>
        <div class="tables-searchbox">

            <span class="tbs-txt">ID：</span>
            <input type="text" name="id" value="{if $id}{$id}{else}{/if}">

            <button class="btn" type="submit"><i class="gicon-search"></i>搜索</button>

            <span>历史充值：</span>
            {foreach from=$user_ids item=ids}
            <button class="btn userids">{$ids.id}</button>
            {/foreach}

<!--        <span class="tbs-txt">用户姓名：</span>-->
<!--        <input type="text" placeholder="" name="alipay_account_name" value="{$alipay_account_name}">-->
        </div>

    </form>
    <div class="tables-searchbox">
        <span class="tbs-txt">充值金额(RMB)：</span>
        <input type="text" name="money">

        <!--            <span class="tbs-txt">确认金额(RMB)：</span>-->
        <!--            <input type="text" name="again_money">-->
        <button class="btn"  onclick= do_recharge()>充值</button>

    </div>

    <div class="tables-searchbox">
        <button class="btn amount">50</button>
        <button class="btn amount">100</button>
        <button class="btn amount">200</button>
        <button class="btn amount">500</button>
        <button class="btn amount">1000</button>
        <button class="btn amount">2000</button>
        <button class="btn amount">5000</button>
        <button class="btn amount">10000</button>
    </div>
    <!-- end tables-searchbox -->
    <table class="wxtables">
        <colgroup>
            <col width="5%">
            <col width="15%">
            <col width="15%">
<!--            <col width="15%">-->
<!--            <col width="15%">-->
            <col width="15%">
        </colgroup>
        <thead>
        <tr>
            <td>用户ID</td>
            <td>用户昵称</td>
            <td>用户姓名</td>
<!--            <td>手机号</td>-->
<!--            <td>账户余额</td>-->
            <td>操作</td>
        </tr>
        </thead>
        <tbody>

        {foreach from=$data key=key name=loop item=v}
        <tr>
            <td class="user_id" hidden="hidden">{$v.user_id}</td>
            <td>{$v.id}</td>
            <td>{$v.nickname}</td>
            <td>{$v.alipay_account_name|default:'--'}</td>
<!--            <td>{$v.mobile|default:'&#45;&#45;'}</td>-->
<!--            <td>-->
<!--                &lt;!&ndash;<span>￥</span>&ndash;&gt;-->
<!--                <span>{$v.left_money}</span>-->
<!--            </td>-->
            <td>
                <a href="javascript:;" class="btn j_form" title="充值" data-id="{$v.user_id}" >充值</a>
                <a href="/McpFinance/get_account_log/user_id/{$v.user_id}" class="btn" title="明细">明细</a>
            </td>
        </tr>
        {foreachelse}
        <tr>
            <td colspan="20" style="text-align:center">对不起,暂无您要查询的数据!</td>
        </tr>
        {/foreach}
        </tbody>
    </table>
    <!-- end wxtables -->
    <div class="tables-btmctrl clearfix">
        <div class="fl">
        </div>
        <div class="fr">
            <div class="paginate">
                {$page}
            </div>
            <!-- end paginate -->
        </div>
    </div>
    <!-- end tables-btmctrl -->
</div>
<!-- end tablesWrap -->
{/block}

{block name="js"}
{literal}
<script>
    var flag = true;
    $(function() {

        var html='<form id="pop_demo">                                                                '+
            '<div class="formitems inline">                                                       '+
            '	<label class="fi-name"><span class="colorRed">*</span>变动金额(RMB)：</label>          '+
            '	<div class="form-controls">                                                       '+
            '		<input type="text" id="amount" name="amount" onkeyup="this.value=this.value.replace(/[^\\d]/g,\'\') " onafterpaste="this.value=this.value.replace(/[^\\d]/g,\'\') ">                                 '+
            '		<span class="fi-help-text" id="amount_ts">格式如: 10000</span>       '+
            '	</div>                                                                            '+
            '</div>                                                                               '+
            '<div class="formitems inline">                                                       '+
            '	<label class="fi-name"><span class="colorRed"></span>操作备注：</label>           '+
            '	<div class="form-controls">                                                       '+
            '		<textarea name="remark" id="remark"></textarea>                               '+
            '		<span class="fi-help-text">一般在200字以内</span>                             '+
            '	</div>                                                                            '+
            '</div>																			      '+
            '</form>                                                                              ';

        $(".j_form").click(function(){
            var user_id = $(this).data('id');
            $.jPops.custom({
                title:"金豆充值",
                content:html,
                callback:function(r){
                    acp.popFormStatus=false;//弹窗表单验证状态
                    if(r){

                        $.validator.setDefaults({
                            submitHandler: function() {
                                acp.popFormStatus=true;//设置弹窗表单验证状态为通过
                                var amount=$("#jpops #amount").val();
                                var remark=$("#jpops #remark").val();

                                $.ajax({
                                    url : '/McpFinance/do_recharge',
                                    type : 'POST',
                                    dataType : 'JSON',
                                    timeout : 3000,
                                    data : {action : "set",user_id : user_id,amount : amount, remark : remark},
                                    error : function() {
                                        $.jPops.message({title:"操作提示",content: "操作失败请重试",timing:3000});
                                    },
                                    success : function(result) {
                                        if(result.code == 200)
                                        {
                                            $.jPops.message({title:"操作提示",content: result.msg,timing:3000});
                                            //刷新页面
                                            setTimeout(function(){window.location.reload() },2000);
                                        }
                                        else
                                        {
                                            $.jPops.message({title:"操作提示",content: result.msg,timing:3000});
                                        }
                                    }
                                });

                            }
                        });

                        //表单验证规则
                        $("#pop_demo").validate({
                            rules: {
                                amount: {required: true}
                            },
                            messages: {
                                amount: {required: "请输入变动金额", check_float: "格式如: 10000"}
                            },
                            errorPlacement: acp.form_ShowError,//显示出错信息(这段代码必须加)
                            success:acp.form_HideError//验证成功隐藏错误信息(这段代码必须加)
                        });

                        //模拟提交表单
                        $("#pop_demo").submit();

                        return acp.popFormStatus;//通过表单验证状态确定是否关闭窗口
                    }
                    else{//点击取消按钮执行的事件
                        return true;
                    }
                }

            });
        })
    });

    // 点击金额赋值
    $(".tables-searchbox").on("click", ".amount", function () {
        var amount = $(this).html().trim();
        $("[name='money']").val(amount);
    });

    // 点击金额赋值
    $(".tables-searchbox").on("click", ".userids", function () {
        var user_ids = $(this).html().trim();
        $("[name='id']").val(user_ids);
    });


    function do_recharge() {
        // var id = $(".user_id").html().trim();
        var amount = $("[name='money']").val();
        var id = $("[name='id']").val();
        $.jPops.custom({
            title: "金豆充值",
            content: '确认给用户（' + id + '） 充值' + amount + '元？',
            callback: function (r) {
                if (r) {
                    if (flag) {
                        flag = false;
                    } else {
                        return;
                    }
                    $.ajax({
                        url: '/McpFinance/do_recharge_by_id',
                        type: 'POST',
                        dataType: 'JSON',
                        timeout: 3000,
                        data: {action: "set", id: id, amount: amount, remark: '充值金额'},
                        error: function () {
                            flag = true;
                            $.jPops.message({title: "操作提示", content: "操作失败请重试", timing: 3000});
                        },
                        success: function (result) {
                            flag = true;
                            console.log(result);
                            if (result.code == 200) {
                                $.jPops.message({title: "操作提示", content: result.msg, timing: 3000});
                                //刷新页面
                                setTimeout(function () {
                                    window.location.reload()
                                }, 2000);
                            } else {
                                $.jPops.message({title: "操作提示", content: result.msg, timing: 3000});
                            }
                        }
                    });
                } else {//点击取消按钮执行的事件
                    return true;
                }
            }
        })
    }

</script>
{/literal}
{/block}

{block name="css"}
<link rel="stylesheet" href="/Public/Css/acp/AcpFinance/user_list.css" type="text/css" />
{/block} 
